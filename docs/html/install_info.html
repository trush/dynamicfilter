<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dynamic Filter: Installation Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Dynamic Filter
   </div>
   <div id="projectbrief">Adaptive Query Processing with the Crowd</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Installation Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#install">Installation</a><ul><li class="level2"><a href="#prereqs">Prerequisites (Python 2.7, pip)</a></li>
<li class="level2"><a href="#pg">PostgreSQL Install and Setup</a><ul><li class="level3"><a href="#pginstall">Installation and running</a></li>
<li class="level3"><a href="#pgconfig">Database configuration</a></li>
</ul>
</li>
<li class="level2"><a href="#virtualenv">Virtualenv Install and Activation</a></li>
<li class="level2"><a href="#envsetup">Environment Setup</a></li>
</ul>
</li>
<li class="level1"><a href="#running">Running a Simulation</a><ul><li class="level2"><a href="#simsetup">Setup</a></li>
<li class="level2"><a href="#example">Example: Hotels, two predicates</a></li>
<li class="level2"><a href="#stats">More simulation configurations</a></li>
<li class="level2"><a href="#MULTI_SIM">MULTI_SIM</a></li>
</ul>
</li>
<li class="level1"><a href="#trouble">Troubleshooting</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="install"></a>
Installation</h1>
<p>This part of the guide will walk you through installing the necessary software for the Dynamic Filter. which is a Django project. It will use <a href="https://virtualenv.pypa.io/en/stable/" target="blank_"><code>virtualenv</code></a> for many of the Python packages to create an isolated environment. Using <code>virtualenv</code> is not required, but recommended.</p>
<p>This guide is catered for Mac OS X, but the process should be similar on other systems.</p>
<h2><a class="anchor" id="prereqs"></a>
Prerequisites (Python 2.7, pip)</h2>
<p>This project currently supports only Python 2.7. You likely have Python already installed if you have Mac OS 10.13, but you can check which version using this command on the command line, assuming <code>$&gt;</code> is the prompt: </p><pre class="fragment">$&gt; python --version
</pre><p>If you see a Python 3.x version printed (or get a "command not found" error), you'll want to install Python 2.7. A helpful installation tool for Mac OS X is <a href="https://brew.sh/">Homebrew</a>. See their installation guide. You can then use <code>brew info</code> to check if you have Python 2.7 installed: </p><pre class="fragment">$&gt; brew info python@2 
</pre><p>And to install it if not: </p><pre class="fragment">$&gt; brew install python@2
</pre><p>You will also want the python package installer called <code>pip</code>. If you installed a recent version of Python 2.7, you likely already have <code>pip</code>. You can confirm by checking its version: </p><pre class="fragment">$&gt; pip --version
pip 10.0.1 from /Library/Python/2.7/site-packages/pip-10.0.1-py2.7.egg (python 2.7)    
</pre><p>It's usually a good idea to make sure you're using the latest version of <code>pip</code>. To update it: </p><pre class="fragment">$&gt; pip install -U pip
</pre><p>If you don't have <code>pip</code>, check out the <a href="https://packaging.python.org/tutorials/installing-packages/" target="blank_">Python packages installation guide</a>.</p>
<h2><a class="anchor" id="pg"></a>
PostgreSQL Install and Setup</h2>
<p>This project uses <a href="https://www.postgresql.org/" target="blank_">PostgresQL</a> as its database backend for Django. This section will first guide you through installing PostgreSQL and starting/stopping it as <a href="https://www.postgresql.org/docs/current/static/tutorial-arch.html">a server process</a> that accepts requests from client programs, such as the Dynamic Filter Django project. The second part of this section gets a Postgres database set up to use with Dynamic Filter.</p>
<h3><a class="anchor" id="pginstall"></a>
Installation and running</h3>
<p>We recommend using Homebrew to install Postgres. This may take some time if there are dependencies that need to be installed at the same time: </p><pre class="fragment">$&gt; brew install postgres
</pre><p>At the end of the installation, Homebrew shows you the commands to start Postgres (if you missed it, you can see it again with the command <code>brew info postgres</code>). As mentioned there, one option is to start the Postgres server using the <code>pg_ctl</code> program, which would look something like this: </p><pre class="fragment">$&gt; pg_ctl -D /usr/local/var/postgres start
</pre><p>To stop, simply replace the "start" with "stop".</p>
<p>If you want Postgres to start automatically every time you turn on your computer, you can ask Homebrew to run it as a service. You can first get Homebrew's services if you don't have it already: </p><pre class="fragment">$&gt; brew tap homebrew/services
</pre><p>Then tell Homebrew to start Postgres as a service: </p><pre class="fragment">$&gt; brew services start postgresql
</pre><h3><a class="anchor" id="pgconfig"></a>
Database configuration</h3>
<p>The Django project for Dynamic Filter needs its own login credentials to interact with Postgres. The username and password should be the same as what is specified in the <code>DATABASES</code> configuration in <code><a class="el" href="settings_8py.html">dynamicfiltersite/settings.py</a></code>. Here we'll assume a username of "webapp" with the password "dynamicfilter". To get started with the setup, use the command-line client program <code>psql</code> to open a session with Postgres: </p><pre class="fragment">$&gt; psql postgres
psql (10.3)
Type "help" for help.

postgres=# 
</pre><p>Now you are logged in to a database called <code>postgres</code>, with a username that likely matches your computer's username. At the prompt, enter <code>\du</code> to see a list of users. You can also view a list of databases using the command <code>\list</code>.</p>
<p>Next we'll create a user and a database to be used with the Django project. At the Postgres prompt, create the user with password: </p><pre class="fragment">postgres=# CREATE ROLE webapp WITH LOGIN PASSWORD 'dynamicfilter';
</pre><p>Enter <code>\du</code> to make sure that you actually created a new user. Note that <code>webapp</code> has no permissions yet. Now we'll fix that. Enter: </p><pre class="fragment">postgres=# ALTER ROLE webapp CREATEDB;
</pre><p>Enter <code>\du</code> again to make sure <code>webapp</code> actually has the ability to create databases. Then use <code>\q</code> to leave the <code>psql</code> command-line.</p>
<p>Next we'll login to <code>psql</code>, this time as the newly created <code>webapp</code> user: </p><pre class="fragment">$&gt; psql postgres -U webapp
</pre><p>Finally, we need to create a database for use with the Dynamic Filter project: </p><pre class="fragment">postgres=# CREATE DATABASE dynamicfilter4;
</pre><p>You can use <code>\list</code> to ensure the database shows up in the list of databases. Then use <code>\q</code> to exit <code>psql</code>.</p>
<h2><a class="anchor" id="virtualenv"></a>
Virtualenv Install and Activation</h2>
<p>A "virtual environment" is a helpful tool for keeping the dependencies required by a project isolated on your computer. For example, you can prevent the dependencies needed for a Python 2.7 project from interfering with a Python 3 project. While not required, we recommend using it.</p>
<p>You can install <code>virtualenv</code> using <code>pip</code>: </p><pre class="fragment">$&gt; pip install virtualenv
</pre><p>With <code>virtualenv</code> installed, we can now create the environment to run Dynamic Filter. We'll first create a virtual environment called <code>dfenv</code> (you can name it whatever you want) and install the dependencies needed for the project within that environment.</p>
<p>Creating a virtual environment using <code>virtualenv</code> will make a new directory with the same name as the environment, as well as create several subdirectories. To help prevent any confusion with the directories associated with the Dynamic Filter project, we recommend running the following command in the <em><b>parent</b></em> directory of where you cloned this Github project. For example, if you cloned into <code>/grandparent/parent/dynamicfilter</code>, we recomend running the command in <code>/grandparent/parent</code>.</p>
<p>First we'll create the environment and explicitly state which python will be used. You should replace the path in the following command with what is right for you: </p><pre class="fragment">$&gt; virtualenv -p /usr/bin/python dfenv
</pre><p>To "jump into" the environment, enter: </p><pre class="fragment">$&gt; source dfenv/bin/activate
</pre><p>You should see the environment name prepended to your command prompt. Note: when you want to "jump out", you can enter: </p><pre class="fragment">(dfenv) $&gt; deactivate
</pre><h2><a class="anchor" id="envsetup"></a>
Environment Setup</h2>
<p>Whether or not you use <code>virtualenv</code>, you will need to install Django and the python dependencies needed for this project.</p>
<p>The latest version of Django that supports Python 2.7 is <a href="https://docs.djangoproject.com/en/1.11/" target="blank_">Django 1.11</a>, so we'll install that using <code>pip</code>: </p><pre class="fragment">(dfenv) $&gt; pip install Django==1.11
</pre><p>Next we will install the python packages <code>psycopg2</code>, <code>numpy</code>, <code>scipy</code>, <code>seaborn</code>, and <code>matplotlib</code>. The first package helps Python talk to Postgres. We need <code>numpy</code> and <code>scipy</code> for certain numerical tools and the rest for creating plots.</p>
<p>You can use <code>pip</code> to install each of these packages inside your virtual environment, replacing "PACKAGE" with each of the package names: </p><pre class="fragment">(dfenv) $&gt; pip install PACKAGE
</pre><h1><a class="anchor" id="running"></a>
Running a Simulation</h1>
<p>Now that the project is installed, we can run a few simulations of Dynamic Filter to see it in action. The simulations run as part of the unit testing framework within Django. We'll be running commands from the Dynamic Filter directory that contains <code><a class="el" href="manage_8py.html">manage.py</a></code> (currently called <code>active</code>); <code>cd</code> into that directory if you aren't there already.</p>
<h2><a class="anchor" id="simsetup"></a>
Setup</h2>
<p>Before we run simulations, you should check that Postgres has an up-to-date understanding of the Django models (described in in <code><a class="el" href="models_8py.html">models.py</a></code>). Django manages updates to its models with <em>migrations</em>, which are essentially a log of changes to the models that can be (re)played to update the models' representation in the Postgres database.</p>
<p>First apply the initial migration to create the database tables: </p><pre class="fragment">(dfenv) $&gt; python manage.py migrate
</pre><p>Now check if Django needs to make any new migration files to reflect changes in <code><a class="el" href="models_8py.html">models.py</a></code> that have been made since the initial one: </p><pre class="fragment">(dfenv) $&gt; python manage.py makemigrations dynamicfilterapp
</pre><p>Then apply those migrations: </p><pre class="fragment">(dfenv) $&gt; python manage.py migrate
</pre><h2><a class="anchor" id="example"></a>
Example: Hotels, two predicates</h2>
<p>On to simulations! The testing framework can run a variety of configurations. These settings live in the <code>toggles.py</code> file. Open <code>toggles.py</code> in a text editor so that you can make changes. We will be using the "Hotel" data set and simulating Dynamic Filter with two predicates: <em>Has a gym?</em> and <em>Costs under $80/night?</em>. As a note, more documentation on the settings in this file can be found on the <a class="el" href="toggles.html">Toggles Info </a> page.</p>
<p>Once you have opened <code>toggles.py</code>, you can decide how you want to set the <code>DEBUG_FLAG</code>; setting it to <code>True</code> will cause debugging information to print to the console.</p>
<p>Next, move onto the Input Settings section and be sure you have these values: </p><pre class="fragment">REAL_DATA = True

INPUT_PATH = 'dynamicfilterapp/simulation_files/hotels/'
ITEM_TYPE = "Hotel"
IP_PAIR_DATA_FILE = 'hotel_cleaned_data.csv'
REAL_DISTRIBUTION_FILE = 'workerDist.csv'
</pre><p>To select the two predicates we want to use, set the chosen predicates (the one for use with <code>REAL_DATA</code>): </p><pre class="fragment">CHOSEN_PREDS = [0,1]
</pre><p>In the Algorithm Settings section, denote that we'll be using the "nu" pending eddy algorithm with this queue size: </p><pre class="fragment">EDDY_SYS = 5
PENDING_QUEUE_SIZE = 1
</pre><p>In the Consensus Settings, be sure you have: </p><pre class="fragment">BAYES_ENABLED = True
</pre><p>For the simulation settings, we'll do two simulations runs: </p><pre class="fragment">NUM_SIM = 2
</pre><p>Finally, for the Output Settings, we'll ask for graphs to be made, particularly the graph that shows the distribution of task counts for the simulations (note that the graphs will appear in a subdirectory denoted by <code>OUTPUT_PATH/RUN_NAME</code>): </p><pre class="fragment">GEN_GRAPHS = True
PACKING = True
RUN_TASKS_COUNT = True
</pre><p>All other true/false settings should be <code>False</code> and other numerical settings can remain as their default values.</p>
<p>Save and close <code>toggles.py</code> and run the simulation: </p><pre class="fragment">(dfenv) $&gt; python manage.py test dynamicfilterapp.test_simulations
</pre><p>You will be prompted to confirm that you <em>really</em> do want graphs produced, to which you can say yes. Hopefully the run succeeded and you can view the task count graph! For this configuration you should expect an average task count around 600.</p>
<h2><a class="anchor" id="stats"></a>
More simulation configurations</h2>
<p>Here are a few other settings you can experiment with:</p>
<ul>
<li><p class="startli">You can get more plots that describe what happened during the simulations by setting these two flags: </p><pre class="fragment">RUN_MULTI_ROUTING = True
COUNT_TICKETS = True
</pre><p class="startli">Turning on <code>RUN_MULTI_ROUTING</code> will yield a bar plot at the end of all simulation runs that shows for each predicate how many items were routed to that predicate <em>first</em>; these figures represent an average all simulation runs. Turning on <code>COUNT_TICKETS</code> will yield one plot <b>per simulation run</b> that depicts how many tickets each predicate had over time during the run.</p>
</li>
<li><p class="startli">The value of <code>EDDY_SYS</code> determines which routing algorithm to use. So far we've been using the Dynamic Filter (aka the pending eddy) algorithm. You can also try using a random routing algorithm by setting <code>EDDY_SYS = 2</code>. Or you could try an algorithm that always first routes items to the first predicate in the CHOSEN_PREDS array (use <code>EDDY_SYS = 3</code>). See the <a class="el" href="toggles.html">Toggles Info </a> page for more information.</p>
<p class="startli">Note: since these comparison algorithms don't use lottery scheduling with tickets, you can set <code>COUNT_TICKETS = False</code> to avoid having pointless plots generated (no pun intended).</p>
</li>
<li><p class="startli">Instead of using the "Hotel" data set, which consists of real worker responses from Amazon's Mechanical Turk, you can use synthetic data. You should turn off <code>REAL_DATA</code> and choose how many predicates (questions) and items, e.g., </p><pre class="fragment">REAL_DATA = False

NUM_QUESTIONS = 2
NUM_ITEMS = 5
</pre><p class="startli">You'll also need to choose the selectivity and ambiguity for each predicate and enter it into <code>switch_list</code>. The tuples are of the form <code>(task number, (select,amb), (select,amb))</code>. To keep the same selectivity and ambiguity throughout the simulation you'll just need one tuple that starts at task <code>0</code>. For example: </p><pre class="fragment">switch_list = [ (0, (0.9, 0.75), (0.2, 0.75))]
</pre></li>
</ul>
<h2><a class="anchor" id="MULTI_SIM"></a>
MULTI_SIM</h2>
<p>NUM_SIM controls the number of simulations that will run with the general toggle settings. However, besides manually setting up and running test settings one at a time, there are two variables in toggles, MULTI_SIM and MULTI_SIM_ARRAY which let you specify many different sets of toggle settings, # of simulations for those settings, etc, and will print most of the important graphs that you need, if those toggles are on. MULTI_SIM_ARRAY is a list of tuples, each of which defines settings for a test. The format for these tuples is as follows: (number of simulations, switch_list, EDDY_SYS, BATCH_ASSIGNMENT, ACTIVE_TASKS_ARRAY, REFILL_PERIOD, TICKETING_SYS, ADAPTIVE_QUEUE_MODE, QUEUE_LENGTH_ARRAY or PENDING_QUEUE_SIZE, (IP_LIMIT_SYS, ITEM_IP_LIMIT)).</p>
<p>An example of an array which will run a single test, with what we generally consider our "default" settings is [(1,[(0, (.1,.25), (.3,.25), (.5,.25), (.5,.25), (.7,.25), (.9,.25))],5,1,[(0, 0, 0), (1, 10, 40), (10, 150, 200), (50, 350, 450)], 100, 1, 4, 100, (0, 1))]. Notably, if you don't want to change a setting between two runs, just put None where it would appear in the tuple. For instance, if I wanted to run the default test, followed by a single test with a different ticketing system, I would enter [(1,[(0, (.1,.25), (.3,.25), (.5,.25), (.5,.25), (.7,.25), (.9,.25))],5,1,[(0, 0, 0), (1, 10, 40), (10, 150, 200), (50, 350, 450)], 100, 1, 4, 100, (0, 1)),(None,None,None,None,None,None,0,None,None,None)]. Although writing out the Nones can be a pain, we've generally found it makes it easier to look back at a series of tests you ran and see what was different between them.</p>
<p>Note, although technically having your very first tuple as all None should hypothetically use the settings defined elsewhere in toggles, we haven't really tested to make sure that happens, so it's best practice to at least fully set up the first tuple completely.</p>
<h1><a class="anchor" id="trouble"></a>
Troubleshooting</h1>
<p>If you get an error like this when trying to run a simulation: </p><pre class="fragment">    from matplotlib.backends import _macosx
RuntimeError: Python is not installed as a framework. The Mac OS X backend will not be able to function correctly...
</pre><p>Find the file <code>matplotlibrc</code> that is inside the <code>matplotlib</code> package inside your virtual environment directory. E.g., if your environment is called <code>dfenv</code>, you may find it here: </p><pre class="fragment">dfenv/lib/python2.7/site-packages/matplotlib/mpl-data/matplotlibrc
</pre><p>Open the file with a text editor and find the <code>backend</code> parameter. Change its value to <code>TkAgg</code> and save the file. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
